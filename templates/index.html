<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Run Tracker</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="/family_run/static/manifest.json">

    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="/family_run/static/apple-touch-icon.png">

    <!-- Theme Color for Mobile Browsers -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Run Tracker">

    <!-- Standard Favicon -->
    <link rel="icon" type="image/png" sizes="192x192" href="/family_run/static/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/family_run/static/icon-512.png">
    <style>
        :root {
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --card-bg: white;
            --card-shadow: rgba(0,0,0,0.1);
            --text-primary: #333;
            --text-secondary: #555;
            --text-tertiary: #999;
            --form-bg: #f8f9fa;
            --border-color: #ddd;
            --highlight-color: #667eea;
            --highlight-hover: #5568d3;
            --success-bg: #f0f9f4;
            --current-week-bg: #fff3cd;
            --hover-bg: #f8f9fa;
        }

        body.dark-mode {
            --bg-gradient-start: #1a1a2e;
            --bg-gradient-end: #16213e;
            --card-bg: #2d2d44;
            --card-shadow: rgba(0,0,0,0.3);
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --text-tertiary: #707070;
            --form-bg: #1f1f2e;
            --border-color: #444;
            --highlight-color: #7c8fe5;
            --highlight-hover: #6a7cd6;
            --success-bg: #1a3328;
            --current-week-bg: #3d3520;
            --hover-bg: #3a3a52;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
               background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
               min-height: 100vh; padding: 20px; transition: background 0.3s ease; }
        .container { max-width: 1000px; margin: 0 auto; }
        h1 { color: white; text-align: center; margin-bottom: 30px; font-size: 2.5em; }
        h2 { color: var(--text-primary); margin-bottom: 20px; font-size: 1.5em; }
        h3 { color: var(--text-secondary); margin-bottom: 15px; font-size: 1.2em; }
        .current-week { background: var(--card-bg); border-radius: 12px; padding: 30px; margin-bottom: 30px;
                        box-shadow: 0 4px 6px var(--card-shadow); transition: background 0.3s ease; }
        .current-week h2 { text-align: center; color: var(--highlight-color); }
        #current-week-display { color: var(--highlight-color); }
        .add-run-form { background: var(--form-bg); border-radius: 8px; padding: 20px; margin: 20px 0; transition: background 0.3s ease; }
        #run-form { display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; }
        .form-group { flex: 1; min-width: 150px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: var(--text-secondary); }
        .form-group select, .form-group input { width: 100%; padding: 10px; border: 2px solid var(--border-color);
                                                border-radius: 6px; font-size: 16px; transition: border-color 0.3s;
                                                background: var(--card-bg); color: var(--text-primary); }
        .form-group select:focus, .form-group input:focus { outline: none; border-color: var(--highlight-color); }
        button[type="submit"] { padding: 10px 30px; background: var(--highlight-color); color: white; border: none;
                                border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer;
                                transition: background 0.3s; }
        button[type="submit"]:hover { background: var(--highlight-hover); }
        #message { margin-top: 15px; padding: 10px; border-radius: 6px; text-align: center; font-weight: 500; }
        #message.success { background: #d4edda; color: #155724; }
        #message.error { background: #f8d7da; color: #721c24; }
        .current-summary { margin-top: 30px; }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; }
        .summary-card { background: var(--card-bg); border: 3px solid var(--border-color); border-radius: 8px;
                        padding: 20px; text-align: center; transition: all 0.3s; }
        .summary-card.has-run { border-color: #28a745; background: var(--success-bg); }
        .member-name { font-weight: 600; font-size: 1.1em; color: var(--text-primary); margin-bottom: 10px; }
        .member-total { font-size: 0.85em; color: var(--text-secondary); margin-bottom: 10px; font-weight: 500; }
        .member-status { font-size: 2em; margin: 10px 0; }
        .summary-card.has-run .member-status { color: #28a745; }
        .summary-card:not(.has-run) .member-status { color: var(--text-tertiary); }
        .member-km { font-size: 1.2em; color: var(--highlight-color); font-weight: 600; min-height: 1.5em; }
        .history { background: var(--card-bg); border-radius: 12px; padding: 30px;
                   box-shadow: 0 4px 6px var(--card-shadow); transition: background 0.3s ease; }
        #history-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #history-table thead { background: var(--highlight-color); color: white; }
        #history-table th { padding: 15px; text-align: left; font-weight: 600; }
        #history-table td { padding: 15px; border-bottom: 1px solid var(--border-color); color: var(--text-primary); }
        #history-table tbody tr:hover { background: var(--hover-bg); }
        .current-week-row { background: var(--current-week-bg) !important; }
        .week-cell { font-weight: 500; }
        .badge { display: inline-block; background: var(--highlight-color); color: white; padding: 2px 8px;
                 border-radius: 4px; font-size: 0.75em; margin-left: 8px; }
        .member-cell { text-align: center; font-weight: 500; }
        .member-cell.has-run { color: #28a745; }
        .member-cell.no-run { color: var(--text-tertiary); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .admin-link { color: white; text-decoration: none; padding: 8px 16px; background: rgba(255,255,255,0.2);
                      border-radius: 6px; font-weight: 500; font-size: 0.9em; transition: background 0.3s; }
        .admin-link:hover { background: rgba(255,255,255,0.3); }
        .dark-mode-toggle { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 16px;
                            border-radius: 6px; cursor: pointer; font-size: 1.2em; transition: background 0.3s; }
        .dark-mode-toggle:hover { background: rgba(255,255,255,0.3); }
        @media (max-width: 768px) {
            body { padding: 10px; }
            h1 { font-size: 2em; }
            .header { flex-direction: column; gap: 10px; align-items: center; }
            .current-week, .history { padding: 20px; }
            #run-form { flex-direction: column; align-items: stretch; }
            .form-group { min-width: 100%; }
            button[type="submit"] { width: 100%; }
            #history-table { font-size: 0.9em; }
            #history-table th, #history-table td { padding: 10px 5px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÉ Family Run Tracker</h1>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button class="dark-mode-toggle" id="dark-mode-toggle" aria-label="Toggle dark mode">üåô</button>
                <a href="/family_run/admin" class="admin-link">ü§ñ Agent Tasks</a>
            </div>
        </div>

        <!-- Current Week Section -->
        <div class="current-week">
            <h2>Current Week: <span id="current-week-display">Loading...</span></h2>

            <div class="add-run-form">
                <h3>Add a Run</h3>
                <form id="run-form">
                    <div class="form-group">
                        <label for="member">Who ran?</label>
                        <select id="member" required>
                            {% for member in family_members %}
                            <option value="{{ member }}">{{ member }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="km">Distance (km)</label>
                        <input type="number" id="km" step="0.1" min="0.1" required>
                    </div>

                    <button type="submit">Add Run</button>
                </form>
                <div id="message"></div>
            </div>

            <!-- Current Week Summary -->
            <div class="current-summary">
                <h3>This Week's Progress</h3>
                <div id="current-week-summary" class="week-summary">
                    Loading...
                </div>
            </div>
        </div>

        <!-- Historical Data Table -->
        <div class="history">
            <h2>Running History</h2>
            <table id="history-table">
                <thead>
                    <tr>
                        <th>Week</th>
                        {% for member in family_members %}
                        <th>{{ member }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let currentWeekKey = null;
        let memberTotals = {};

        // Load data and populate the page
        async function loadData() {
            try {
                const response = await fetch('/family_run/api/data');
                const data = await response.json();

                currentWeekKey = data.current_week;
                memberTotals = data.member_totals || {};
                document.getElementById('current-week-display').textContent = data.current_week_display;

                // Update current week summary
                updateCurrentWeekSummary(data.weeks);

                // Update history table
                updateHistoryTable(data.weeks);
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Update current week summary
        function updateCurrentWeekSummary(weeks) {
            const currentWeek = weeks.find(w => w.is_current);
            const summaryDiv = document.getElementById('current-week-summary');

            if (!currentWeek) {
                summaryDiv.innerHTML = '<p>No runs yet this week. Get started!</p>';
                return;
            }

            let html = '<div class="summary-cards">';
            const members = ['Gabor', 'Petia', 'David'];

            members.forEach(member => {
                const memberData = currentWeek.members[member];
                const totalKm = memberData.total_km;
                const hasRun = memberData.has_run;
                const overallTotal = memberTotals[member] || 0;

                html += `
                    <div class="summary-card ${hasRun ? 'has-run' : ''}">
                        <div class="member-name">${member}</div>
                        <div class="member-total">Total: ${overallTotal.toFixed(1)} km</div>
                        <div class="member-status">
                            ${hasRun ? '‚úì' : '0'}
                        </div>
                        <div class="member-km">${totalKm > 0 ? totalKm.toFixed(1) + ' km' : ''}</div>
                    </div>
                `;
            });

            html += '</div>';
            summaryDiv.innerHTML = html;
        }

        // Update history table
        function updateHistoryTable(weeks) {
            const tbody = document.querySelector('#history-table tbody');
            tbody.innerHTML = '';

            weeks.forEach(week => {
                const row = document.createElement('tr');
                if (week.is_current) {
                    row.classList.add('current-week-row');
                }

                // Week column
                const weekCell = document.createElement('td');
                weekCell.className = 'week-cell';
                weekCell.innerHTML = `
                    <strong>${week.week_display}</strong>
                    ${week.is_current ? '<span class="badge">Current</span>' : ''}
                `;
                row.appendChild(weekCell);

                // Member columns
                const members = ['Gabor', 'Petia', 'David'];
                members.forEach(member => {
                    const memberData = week.members[member];
                    const cell = document.createElement('td');
                    cell.className = 'member-cell';

                    if (memberData.has_run) {
                        cell.classList.add('has-run');
                        cell.innerHTML = `‚úì ${memberData.total_km.toFixed(1)} km`;
                    } else {
                        cell.classList.add('no-run');
                        cell.textContent = '0';
                    }

                    row.appendChild(cell);
                });

                tbody.appendChild(row);
            });
        }

        // Handle form submission
        document.getElementById('run-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const member = document.getElementById('member').value;
            const km = document.getElementById('km').value;
            const messageDiv = document.getElementById('message');

            try {
                const response = await fetch('/family_run/api/add-run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ member, km: parseFloat(km) }),
                });

                if (response.ok) {
                    messageDiv.textContent = `‚úì Added ${km} km for ${member}!`;
                    messageDiv.className = 'success';
                    document.getElementById('km').value = '';

                    // Reload data
                    await loadData();

                    // Clear message after 3 seconds
                    setTimeout(() => {
                        messageDiv.textContent = '';
                        messageDiv.className = '';
                    }, 3000);
                } else {
                    const error = await response.json();
                    messageDiv.textContent = `Error: ${error.error}`;
                    messageDiv.className = 'error';
                }
            } catch (error) {
                console.error('Error adding run:', error);
                messageDiv.textContent = 'Error adding run. Please try again.';
                messageDiv.className = 'error';
            }
        });

        // Dark mode functionality
        function initDarkMode() {
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const isDarkMode = localStorage.getItem('darkMode') === 'true';

            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                darkModeToggle.textContent = '‚òÄÔ∏è';
            }

            darkModeToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                const isNowDark = document.body.classList.contains('dark-mode');
                localStorage.setItem('darkMode', isNowDark);
                darkModeToggle.textContent = isNowDark ? '‚òÄÔ∏è' : 'üåô';
            });
        }

        // Load data on page load
        loadData();
        initDarkMode();
    </script>
</body>
</html>
