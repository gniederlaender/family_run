<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Run Tracker</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="/family_run/static/manifest.json">

    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="/family_run/static/apple-touch-icon.png">

    <!-- Theme Color for Mobile Browsers -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Run Tracker">

    <!-- Standard Favicon -->
    <link rel="icon" type="image/png" sizes="192x192" href="/family_run/static/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/family_run/static/icon-512.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
               background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        h1 { color: white; text-align: center; margin-bottom: 30px; font-size: 2.5em; }
        h2 { color: #333; margin-bottom: 20px; font-size: 1.5em; }
        h3 { color: #555; margin-bottom: 15px; font-size: 1.2em; }
        .current-week { background: white; border-radius: 12px; padding: 30px; margin-bottom: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .current-week h2 { text-align: center; color: #667eea; }
        #current-week-display { color: #764ba2; }
        .add-run-form { background: #f8f9fa; border-radius: 8px; padding: 20px; margin: 20px 0; }
        #run-form { display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; }
        .form-group { flex: 1; min-width: 150px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: #555; }
        .form-group select, .form-group input { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px;
                                                font-size: 16px; transition: border-color 0.3s; }
        .form-group select:focus, .form-group input:focus { outline: none; border-color: #667eea; }
        button[type="submit"] { padding: 10px 30px; background: #667eea; color: white; border: none; border-radius: 6px;
                                font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.3s; }
        button[type="submit"]:hover { background: #5568d3; }
        #message { margin-top: 15px; padding: 10px; border-radius: 6px; text-align: center; font-weight: 500; }
        #message.success { background: #d4edda; color: #155724; }
        #message.error { background: #f8d7da; color: #721c24; }
        .current-summary { margin-top: 30px; }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; }
        .summary-card { background: white; border: 3px solid #ddd; border-radius: 8px; padding: 20px; text-align: center; transition: all 0.3s; }
        .summary-card.has-run { border-color: #28a745; background: #f0f9f4; }
        .member-name { font-weight: 600; font-size: 1.1em; color: #333; margin-bottom: 10px; }
        .member-status { font-size: 2em; margin: 10px 0; }
        .summary-card.has-run .member-status { color: #28a745; }
        .summary-card:not(.has-run) .member-status { color: #999; }
        .member-km { font-size: 1.2em; color: #667eea; font-weight: 600; min-height: 1.5em; }
        .history { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #history-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #history-table thead { background: #667eea; color: white; }
        #history-table th { padding: 15px; text-align: left; font-weight: 600; }
        #history-table td { padding: 15px; border-bottom: 1px solid #eee; }
        #history-table tbody tr:hover { background: #f8f9fa; }
        .current-week-row { background: #fff3cd !important; }
        .week-cell { font-weight: 500; }
        .badge { display: inline-block; background: #667eea; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75em; margin-left: 8px; }
        .member-cell { text-align: center; font-weight: 500; }
        .member-cell.has-run { color: #28a745; }
        .member-cell.no-run { color: #999; }
        @media (max-width: 768px) {
            body { padding: 10px; }
            h1 { font-size: 2em; }
            .current-week, .history { padding: 20px; }
            #run-form { flex-direction: column; align-items: stretch; }
            .form-group { min-width: 100%; }
            button[type="submit"] { width: 100%; }
            #history-table { font-size: 0.9em; }
            #history-table th, #history-table td { padding: 10px 5px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèÉ Family Run Tracker</h1>

        <!-- Current Week Section -->
        <div class="current-week">
            <h2>Current Week: <span id="current-week-display">Loading...</span></h2>

            <div class="add-run-form">
                <h3>Add a Run</h3>
                <form id="run-form">
                    <div class="form-group">
                        <label for="member">Who ran?</label>
                        <select id="member" required>
                            {% for member in family_members %}
                            <option value="{{ member }}">{{ member }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="km">Distance (km)</label>
                        <input type="number" id="km" step="0.1" min="0.1" required>
                    </div>

                    <button type="submit">Add Run</button>
                </form>
                <div id="message"></div>
            </div>

            <!-- Current Week Summary -->
            <div class="current-summary">
                <h3>This Week's Progress</h3>
                <div id="current-week-summary" class="week-summary">
                    Loading...
                </div>
            </div>
        </div>

        <!-- Historical Data Table -->
        <div class="history">
            <h2>Running History</h2>
            <table id="history-table">
                <thead>
                    <tr>
                        <th>Week</th>
                        {% for member in family_members %}
                        <th>{{ member }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let currentWeekKey = null;

        // Load data and populate the page
        async function loadData() {
            try {
                const response = await fetch('/family_run/api/data');
                const data = await response.json();

                currentWeekKey = data.current_week;
                document.getElementById('current-week-display').textContent = data.current_week_display;

                // Update current week summary
                updateCurrentWeekSummary(data.weeks);

                // Update history table
                updateHistoryTable(data.weeks);
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Update current week summary
        function updateCurrentWeekSummary(weeks) {
            const currentWeek = weeks.find(w => w.is_current);
            const summaryDiv = document.getElementById('current-week-summary');

            if (!currentWeek) {
                summaryDiv.innerHTML = '<p>No runs yet this week. Get started!</p>';
                return;
            }

            let html = '<div class="summary-cards">';
            const members = ['Gabor', 'Petia', 'David'];

            members.forEach(member => {
                const memberData = currentWeek.members[member];
                const totalKm = memberData.total_km;
                const hasRun = memberData.has_run;

                html += `
                    <div class="summary-card ${hasRun ? 'has-run' : ''}">
                        <div class="member-name">${member}</div>
                        <div class="member-status">
                            ${hasRun ? '‚úì' : '0'}
                        </div>
                        <div class="member-km">${totalKm > 0 ? totalKm.toFixed(1) + ' km' : ''}</div>
                    </div>
                `;
            });

            html += '</div>';
            summaryDiv.innerHTML = html;
        }

        // Update history table
        function updateHistoryTable(weeks) {
            const tbody = document.querySelector('#history-table tbody');
            tbody.innerHTML = '';

            weeks.forEach(week => {
                const row = document.createElement('tr');
                if (week.is_current) {
                    row.classList.add('current-week-row');
                }

                // Week column
                const weekCell = document.createElement('td');
                weekCell.className = 'week-cell';
                weekCell.innerHTML = `
                    <strong>${week.week_display}</strong>
                    ${week.is_current ? '<span class="badge">Current</span>' : ''}
                `;
                row.appendChild(weekCell);

                // Member columns
                const members = ['Gabor', 'Petia', 'David'];
                members.forEach(member => {
                    const memberData = week.members[member];
                    const cell = document.createElement('td');
                    cell.className = 'member-cell';

                    if (memberData.has_run) {
                        cell.classList.add('has-run');
                        cell.innerHTML = `‚úì ${memberData.total_km.toFixed(1)} km`;
                    } else {
                        cell.classList.add('no-run');
                        cell.textContent = '0';
                    }

                    row.appendChild(cell);
                });

                tbody.appendChild(row);
            });
        }

        // Handle form submission
        document.getElementById('run-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const member = document.getElementById('member').value;
            const km = document.getElementById('km').value;
            const messageDiv = document.getElementById('message');

            try {
                const response = await fetch('/family_run/api/add-run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ member, km: parseFloat(km) }),
                });

                if (response.ok) {
                    messageDiv.textContent = `‚úì Added ${km} km for ${member}!`;
                    messageDiv.className = 'success';
                    document.getElementById('km').value = '';

                    // Reload data
                    await loadData();

                    // Clear message after 3 seconds
                    setTimeout(() => {
                        messageDiv.textContent = '';
                        messageDiv.className = '';
                    }, 3000);
                } else {
                    const error = await response.json();
                    messageDiv.textContent = `Error: ${error.error}`;
                    messageDiv.className = 'error';
                }
            } catch (error) {
                console.error('Error adding run:', error);
                messageDiv.textContent = 'Error adding run. Please try again.';
                messageDiv.className = 'error';
            }
        });

        // Load data on page load
        loadData();
    </script>
</body>
</html>
