<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Task Manager - Family Run</title>
    <style>
        :root {
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --card-bg: white;
            --card-shadow: rgba(0,0,0,0.1);
            --text-primary: #333;
            --text-secondary: #555;
            --text-tertiary: #999;
            --form-bg: #f8f9fa;
            --border-color: #ddd;
            --highlight-color: #667eea;
            --highlight-hover: #5568d3;
        }

        body.dark-mode {
            --bg-gradient-start: #1a1a2e;
            --bg-gradient-end: #16213e;
            --card-bg: #2d2d44;
            --card-shadow: rgba(0,0,0,0.3);
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --text-tertiary: #707070;
            --form-bg: #1f1f2e;
            --border-color: #444;
            --highlight-color: #7c8fe5;
            --highlight-hover: #6a7cd6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
               background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
               min-height: 100vh; padding: 20px; transition: background 0.3s ease; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        h1 { color: white; font-size: 2.5em; }
        .back-link { color: white; text-decoration: none; padding: 10px 20px; background: rgba(255,255,255,0.2);
                     border-radius: 6px; font-weight: 500; transition: background 0.3s; }
        .back-link:hover { background: rgba(255,255,255,0.3); }
        .section { background: var(--card-bg); border-radius: 12px; padding: 30px; margin-bottom: 30px;
                   box-shadow: 0 4px 6px var(--card-shadow); transition: background 0.3s ease; }
        h2 { color: var(--highlight-color); margin-bottom: 20px; font-size: 1.8em; }
        h3 { color: var(--text-secondary); margin-bottom: 15px; font-size: 1.2em; }
        .dark-mode-toggle { background: rgba(255,255,255,0.2); border: none; color: white; padding: 10px 20px;
                            border-radius: 6px; cursor: pointer; font-size: 1.2em; transition: background 0.3s;
                            font-weight: 500; }
        .dark-mode-toggle:hover { background: rgba(255,255,255,0.3); }

        /* Add Task Form */
        .task-form { background: var(--form-bg); border-radius: 8px; padding: 20px; margin-bottom: 20px; transition: background 0.3s ease; }
        .form-row { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { margin-bottom: 5px; font-weight: 500; color: var(--text-secondary); font-size: 0.9em; }
        .form-group input, .form-group select, .form-group textarea { padding: 10px; border: 2px solid var(--border-color);
                                                                       border-radius: 6px; font-size: 16px; font-family: inherit;
                                                                       transition: border-color 0.3s; background: var(--card-bg);
                                                                       color: var(--text-primary); }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--highlight-color); }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .btn { padding: 10px 30px; border: none; border-radius: 6px; font-size: 16px; font-weight: 600;
               cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: var(--highlight-color); color: white; }
        .btn-primary:hover { background: var(--highlight-hover); }
        .btn-small { padding: 5px 15px; font-size: 14px; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-warning:hover { background: #e0a800; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }

        /* Tasks List */
        .tasks-container { display: flex; flex-direction: column; gap: 15px; }
        .task-card { background: var(--card-bg); border: 2px solid var(--border-color); border-radius: 8px;
                     padding: 20px; transition: all 0.3s; }
        .task-card:hover { box-shadow: 0 2px 8px var(--card-shadow); }
        .task-card.status-done { background: var(--form-bg); border-color: #28a745; }
        .task-card.status-open { border-left: 4px solid var(--highlight-color); }
        .task-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px; }
        .task-title { font-size: 1.2em; font-weight: 600; color: var(--text-primary); margin-bottom: 5px; }
        .task-meta { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; }
        .badge { display: inline-block; padding: 4px 12px; border-radius: 4px; font-size: 0.85em; font-weight: 500; }
        .badge-type { background: var(--highlight-color); color: white; }
        .badge-priority { background: #ffc107; color: #333; }
        .badge-priority.critical { background: #dc3545; color: white; }
        .badge-priority.high { background: #fd7e14; color: white; }
        .badge-priority.low { background: #6c757d; color: white; }
        .badge-status { background: #28a745; color: white; }
        .badge-status.open { background: #17a2b8; color: white; }
        .task-description { color: var(--text-secondary); margin-bottom: 15px; line-height: 1.5; white-space: pre-wrap; }
        .task-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .task-id { font-size: 0.85em; color: var(--text-tertiary); margin-top: 10px; }

        .message { padding: 15px; border-radius: 6px; margin-bottom: 20px; font-weight: 500; }
        .message.success { background: #d4edda; color: #155724; }
        .message.error { background: #f8d7da; color: #721c24; }
        .message.hidden { display: none; }

        .empty-state { text-align: center; padding: 40px; color: var(--text-tertiary); }

        @media (max-width: 768px) {
            body { padding: 10px; }
            h1 { font-size: 1.8em; }
            .header { flex-direction: column; gap: 15px; align-items: flex-start; }
            .section { padding: 20px; }
            .form-row { grid-template-columns: 1fr; }
            .task-header { flex-direction: column; }
            .task-actions { flex-direction: column; }
            .btn { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Agent Task Manager</h1>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button class="dark-mode-toggle" id="dark-mode-toggle" aria-label="Toggle dark mode">üåô</button>
                <a href="/family_run/" class="back-link">‚Üê Back to Tracker</a>
            </div>
        </div>

        <!-- Add New Task Section -->
        <div class="section">
            <h2>Add New Task</h2>
            <div class="task-form">
                <form id="add-task-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="title">Task Title *</label>
                            <input type="text" id="title" required placeholder="e.g., Add dark mode toggle">
                        </div>
                        <div class="form-group">
                            <label for="type">Type</label>
                            <select id="type">
                                <option value="feature">Feature</option>
                                <option value="bug">Bug</option>
                                <option value="refactor">Refactor</option>
                                <option value="docs">Documentation</option>
                                <option value="test">Test</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="priority">Priority</label>
                            <select id="priority">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                                <option value="critical">Critical</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea id="description" placeholder="Provide details about what needs to be done..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Task</button>
                </form>
            </div>
            <div id="add-message" class="message hidden"></div>
        </div>

        <!-- Tasks List Section -->
        <div class="section">
            <h2>Current Tasks</h2>
            <div id="tasks-container" class="tasks-container">
                <div class="empty-state">Loading tasks...</div>
            </div>
        </div>
    </div>

    <script>
        let allTasks = [];

        // Load all tasks
        async function loadTasks() {
            try {
                const response = await fetch('/family_run/api/feedback');
                const data = await response.json();
                allTasks = data.feedback_items || [];
                renderTasks();
            } catch (error) {
                console.error('Error loading tasks:', error);
                showMessage('Error loading tasks', 'error', 'add-message');
            }
        }

        // Render tasks
        function renderTasks() {
            const container = document.getElementById('tasks-container');

            if (allTasks.length === 0) {
                container.innerHTML = '<div class="empty-state">No tasks yet. Add your first task above!</div>';
                return;
            }

            // Sort: open tasks first, then by priority
            const sortedTasks = [...allTasks].sort((a, b) => {
                if (a.status !== b.status) {
                    return a.status === 'open' ? -1 : 1;
                }
                const priorityOrder = { critical: 0, high: 1, medium: 2, low: 3 };
                return priorityOrder[a.priority] - priorityOrder[b.priority];
            });

            container.innerHTML = sortedTasks.map(task => `
                <div class="task-card status-${task.status}">
                    <div class="task-header">
                        <div>
                            <div class="task-title">${escapeHtml(task.title)}</div>
                            <div class="task-meta">
                                <span class="badge badge-type">${task.type}</span>
                                <span class="badge badge-priority ${task.priority}">${task.priority}</span>
                                <span class="badge badge-status ${task.status}">${task.status}</span>
                            </div>
                        </div>
                    </div>
                    ${task.description ? `<div class="task-description">${escapeHtml(task.description)}</div>` : ''}
                    <div class="task-actions">
                        ${task.status === 'open' ?
                            `<button class="btn btn-small btn-success" onclick="updateTaskStatus('${task.id}', 'done')">Mark as Done</button>` :
                            `<button class="btn btn-small btn-warning" onclick="updateTaskStatus('${task.id}', 'open')">Reopen</button>`
                        }
                        <button class="btn btn-small btn-danger" onclick="deleteTask('${task.id}')">Delete</button>
                    </div>
                    <div class="task-id">ID: ${task.id}</div>
                </div>
            `).join('');
        }

        // Add new task
        document.getElementById('add-task-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const title = document.getElementById('title').value;
            const type = document.getElementById('type').value;
            const priority = document.getElementById('priority').value;
            const description = document.getElementById('description').value;

            try {
                const response = await fetch('/family_run/api/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, type, priority, description })
                });

                if (response.ok) {
                    showMessage('Task added successfully!', 'success', 'add-message');
                    document.getElementById('add-task-form').reset();
                    await loadTasks();
                } else {
                    const error = await response.json();
                    showMessage(`Error: ${error.error}`, 'error', 'add-message');
                }
            } catch (error) {
                console.error('Error adding task:', error);
                showMessage('Error adding task', 'error', 'add-message');
            }
        });

        // Update task status
        async function updateTaskStatus(taskId, newStatus) {
            try {
                const response = await fetch(`/family_run/api/feedback/${taskId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });

                if (response.ok) {
                    await loadTasks();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error}`);
                }
            } catch (error) {
                console.error('Error updating task:', error);
                alert('Error updating task');
            }
        }

        // Delete task
        async function deleteTask(taskId) {
            if (!confirm('Are you sure you want to delete this task?')) {
                return;
            }

            try {
                const response = await fetch(`/family_run/api/feedback/${taskId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    await loadTasks();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error}`);
                }
            } catch (error) {
                console.error('Error deleting task:', error);
                alert('Error deleting task');
            }
        }

        // Show message
        function showMessage(text, type, elementId) {
            const messageDiv = document.getElementById(elementId);
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            setTimeout(() => {
                messageDiv.className = 'message hidden';
            }, 3000);
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Dark mode functionality
        function initDarkMode() {
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const isDarkMode = localStorage.getItem('darkMode') === 'true';

            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                darkModeToggle.textContent = '‚òÄÔ∏è';
            }

            darkModeToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                const isNowDark = document.body.classList.contains('dark-mode');
                localStorage.setItem('darkMode', isNowDark);
                darkModeToggle.textContent = isNowDark ? '‚òÄÔ∏è' : 'üåô';
            });
        }

        // Load tasks on page load
        loadTasks();
        initDarkMode();
    </script>
</body>
</html>
